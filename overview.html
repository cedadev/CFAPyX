
<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The CFA-Xarray Engine &mdash; CFAPyX v1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=3dd8cc91"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Xarray Backend Entrypoint for CFAPyX" href="backendentrypoint.html" />
    <link rel="prev" title="CFA and Distributed Data" href="inspiration.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            CFAPyX
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="inspiration.html">Inspiration for CFA</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Xarray Engine Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#entrypoint">1. Entrypoint</a></li>
<li class="toctree-l2"><a class="reference internal" href="#datastore">2. Datastore</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-from-fragments">3. Data from Fragments</a></li>
<li class="toctree-l2"><a class="reference internal" href="#result">4. Result</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="backendentrypoint.html">CFA Backend Entrypoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="datastore.html">CFA DataStore</a></li>
<li class="toctree-l1"><a class="reference internal" href="fragmentarray.html">CFA Fragment Array</a></li>
<li class="toctree-l1"><a class="reference internal" href="groups.html">NetCDF group handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils.html">Utilities</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">CFAPyX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">The CFA-Xarray Engine</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/overview.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="the-cfa-xarray-engine">
<h1>The CFA-Xarray Engine<a class="headerlink" href="#the-cfa-xarray-engine" title="Permalink to this heading"></a></h1>
<p>CFAPyX is registered as an available backend to xarray when installed into your virtual environment, which means that xarray will
collect the package and add it to a list of backends on performing <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">xarray</span></code>.</p>
<section id="entrypoint">
<h2>1. Entrypoint<a class="headerlink" href="#entrypoint" title="Permalink to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">CFANetCDFBackendEntrypoint()</span></code> class provides a method called <code class="docutils literal notranslate"><span class="pre">open_dataset</span></code> which feeds the output of <code class="docutils literal notranslate"><span class="pre">open_cfa_dataset</span></code> directly back into xarray.
There are other methods which may be useful to implement in the future, but for now only the basic opener is used.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Most CFA classes in this module inherit from equivalent NetCDF4 classes directly from Xarray, since only a small number of additional or override
methods are required. There is therefore a large number of methods with CFA classes that are not used directly within this package.</p>
</div>
<p>Opening a CFA dataset requires opening the CFA-netCDF file into a <code class="docutils literal notranslate"><span class="pre">CFADataStore</span></code> object (inherits from Xarray’s <code class="docutils literal notranslate"><span class="pre">NetCDF4DataStore</span></code>) which is then used as the <code class="docutils literal notranslate"><span class="pre">store</span></code> attribute in later methods inherited from parent Xarray/NetCDF classes.</p>
</section>
<section id="datastore">
<h2>2. Datastore<a class="headerlink" href="#datastore" title="Permalink to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">CFA</span> <span class="pre">Datastore</span></code> handles all unpacking and decoding of CFA variables, as well as handling global and group variables where a group is present. The <code class="docutils literal notranslate"><span class="pre">aggregated</span> <span class="pre">dimensions</span></code> and <code class="docutils literal notranslate"><span class="pre">attributes</span></code> present in a
CFA-netCDF file are unpacked for each variable and returned from <code class="docutils literal notranslate"><span class="pre">get_variables</span></code> as an xarray <code class="docutils literal notranslate"><span class="pre">FrozenDict</span></code> object of xarray <code class="docutils literal notranslate"><span class="pre">Variable</span></code> objects. Each Variable is defined using the dimensions, attributes
and encoding from the CFA file, but the data is more complicated.</p>
</section>
<section id="data-from-fragments">
<h2>3. Data from Fragments<a class="headerlink" href="#data-from-fragments" title="Permalink to this heading"></a></h2>
<p>Xarray comes with an included <code class="docutils literal notranslate"><span class="pre">LazilyIndexedArray</span></code> wrapper for containing indexable Array-like objects. The data is indexed via this first level of wrapper so the data isn’t loaded immediately upon creating the Xarray variable.
CFAPyX provides an Array-like wrapper class called <code class="docutils literal notranslate"><span class="pre">FragmentArrayWrapper</span></code> for handling calls to the whole array of all fragments. At this point we are still dealing with what looks like a single Array in xarray, rather than a
set of distributed <code class="docutils literal notranslate"><span class="pre">Fragments</span></code>. CFAPyX handles these fragments as individual <code class="docutils literal notranslate"><span class="pre">FragmentWrapper</span></code> objects, which are provided to the higher level Xarray wrapper by way of a Dask array, which is created with the Variable.</p>
<p>This means most of the complicated maths to relate an array segment to specific fragments is actually handled by Dask, the only thing the <code class="docutils literal notranslate"><span class="pre">FragmentWrapper</span></code> objects have to do is act like indexable Arrays that only load the data when they are indexed.
This is done using the python <code class="docutils literal notranslate"><span class="pre">netCDF4</span></code> library to load the associated <strong>fragment file</strong> for this fragment, selecting the specific variable (from <cite>cfa_address</cite>) and loading a selection of the array as a numpy array.
Performing the slice operations on the netCDF4 dataset ensures the minimal amount of memory chunks are loaded from the file, since this is built into the netCDF4 library.</p>
</section>
<section id="result">
<h2>4. Result<a class="headerlink" href="#result" title="Permalink to this heading"></a></h2>
<p>All of the above is abstracted from the user into the simple <code class="docutils literal notranslate"><span class="pre">open_dataset</span></code> command from Xarray. The dataset which is built looks like any other xarray dataset, which includes the loaded attributes and a Dask array for each variable.
This only becomes an array of ‘real’ data following a <code class="docutils literal notranslate"><span class="pre">compute()</span></code> or <code class="docutils literal notranslate"><span class="pre">plot()</span></code> method (or equivalent), otherwise the data has yet to be loaded. Performing slices or reduction methods is handled entirely by Dask such that the operations are
combined and applied at the latest stage for optimal performance.</p>
<p>If you would like to read more about lazy loading in general, see this <a class="reference external" href="https://saturncloud.io/blog/a-data-scientist-s-guide-to-lazy-evaluation-with-dask/">SaturnCloud Blog</a>
or visit the <a class="reference external" href="https://docs.dask.org/en/stable/">Dask Documentation</a>.</p>
<p>For more detail specifically on CFA, see either the <a class="reference external" href="https://github.com/NCAS-CMS/cfa-conventions/blob/main/source/cfa.md">CFA specifications</a>
or our page on the Inspiration for CFA.</p>
<dl class="simple">
<dt>Finally if you would like to find out about alternative ways of handling distributed data, specifically for cloud applications, see one of the following:</dt><dd><ul class="simple">
<li><p><a class="reference external" href="https://cedadev.github.io/padocc/">padocc (CEDA)</a>: Pipeline to Aggregate Data for Optimal Cloud Capabilities</p></li>
<li><p><a class="reference external" href="https://fsspec.github.io/kerchunk/">Kerchunk</a>: Reference format</p></li>
<li><p><a class="reference external" href="https://zarr.readthedocs.io/en/stable/">Zarr</a>: Cloud Optimised format</p></li>
<li><p><a class="reference external" href="https://guide.cloudnativegeo.org/#:~:text=Scalability%3A%20Cloud%2Doptimized%20formats%20are,to%20work%20with%20large%20datasets.">Other Cloud Optimised formats</a></p></li>
</ul>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="inspiration.html" class="btn btn-neutral float-left" title="CFA and Distributed Data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="backendentrypoint.html" class="btn btn-neutral float-right" title="Xarray Backend Entrypoint for CFAPyX" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-2024, Centre of Environmental Data Analysis Developers,Scientific and Technical Facilities Council (STFC),UK Research and Innovation (UKRI). BSD 2-Clause License. All rights reserved..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #0ecc5778;
    }

    .caption-text, .header h1 {
        color: #45c347
    }

    .note {
        background: #BEEF9E
    }
    .admonition-title {
        background: #335145
    }

    .wy-nav-side {
        background: #001711;
    }

  </style>


</body>
</html>